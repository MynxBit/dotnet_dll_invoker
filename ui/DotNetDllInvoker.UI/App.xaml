<Application x:Class="DotNetDllInvoker.UI.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:DotNetDllInvoker.UI.ViewModels"
             xmlns:selectors="clr-namespace:DotNetDllInvoker.UI.Selectors"
             StartupUri="Views/MainWindow.xaml">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Themes/DarkTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Local Converters & Templates -->
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>

            <!-- Data Templates for Parameters (The Dynamic Engine) -->
            <DataTemplate x:Key="StringParamTemplate" DataType="{x:Type vm:StringParameterViewModel}">
                <StackPanel Margin="0,5">
                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#4EC9B0"/>
                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>
            </DataTemplate>

            <DataTemplate x:Key="IntParamTemplate" DataType="{x:Type vm:IntParameterViewModel}">
                <StackPanel Margin="0,5">
                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#B5CEA8"/>
                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>
            </DataTemplate>

            <DataTemplate x:Key="BoolParamTemplate" DataType="{x:Type vm:BoolParameterViewModel}">
                 <CheckBox IsChecked="{Binding Value}" Content="{Binding Name}" Margin="0,5" Foreground="{StaticResource TextPrimary}"/>
            </DataTemplate>

            <!-- NEW: Enum Parameter Template -->
            <DataTemplate x:Key="EnumParamTemplate" DataType="{x:Type vm:EnumParameterViewModel}">
                <StackPanel Margin="0,5">
                    <TextBlock FontWeight="Bold" Foreground="#DCDCAA">
                        <Run Text="{Binding Name}"/>
                        <Run Text=" (" Foreground="{StaticResource TextMuted}"/>
                        <Run Text="{Binding TypeName}" Foreground="{StaticResource TextMuted}"/>
                        <Run Text=")" Foreground="{StaticResource TextMuted}"/>
                    </TextBlock>
                    <ComboBox ItemsSource="{Binding EnumValues}" SelectedItem="{Binding SelectedValue}" Margin="0,2,0,0"/>
                </StackPanel>
            </DataTemplate>

            <!-- NEW: JSON Object Parameter Template -->
            <DataTemplate x:Key="JsonParamTemplate" DataType="{x:Type vm:JsonParameterViewModel}">
                <StackPanel Margin="0,5">
                    <TextBlock FontWeight="Bold" Foreground="#CE9178">
                        <Run Text="{Binding Name}"/>
                        <Run Text=" (JSON: " Foreground="{StaticResource TextMuted}"/>
                        <Run Text="{Binding TypeName}" Foreground="{StaticResource TextMuted}"/>
                        <Run Text=")" Foreground="{StaticResource TextMuted}"/>
                    </TextBlock>
                    <TextBox Text="{Binding JsonText, UpdateSourceTrigger=PropertyChanged}" 
                             AcceptsReturn="True" 
                             Height="100" 
                             VerticalScrollBarVisibility="Auto"
                             FontFamily="Consolas"
                             Margin="0,2,0,0"/>
                    <TextBlock Text="{Binding ValidationError}" 
                               Foreground="{StaticResource DangerBrush}" 
                               FontSize="10" 
                               Visibility="{Binding ValidationError, Converter={StaticResource BoolToVis}}"/>
                </StackPanel>
            </DataTemplate>

            <!-- NEW: Collection Parameter Template -->
            <DataTemplate x:Key="CollectionParamTemplate" DataType="{x:Type vm:CollectionParameterViewModel}">
                <StackPanel Margin="0,5">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Left" FontWeight="Bold" Foreground="#569CD6">
                            <Run Text="{Binding Name}"/>
                            <Run Text=" [" Foreground="{StaticResource TextMuted}"/>
                            <Run Text="{Binding ElementType.Name}" Foreground="{StaticResource TextMuted}"/>
                            <Run Text="]" Foreground="{StaticResource TextMuted}"/>
                        </TextBlock>
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                            <Button Content="+" Command="{Binding AddItemCommand}" Width="24" Height="24" Margin="2,0"/>
                            <Button Content="-" Command="{Binding RemoveItemCommand}" Width="24" Height="24"/>
                        </StackPanel>
                    </DockPanel>
                    <ItemsControl ItemsSource="{Binding Items}" Margin="0,5,0,0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <DockPanel Margin="0,2">
                                    <TextBlock DockPanel.Dock="Left" Text="{Binding Index, StringFormat='[{0}]'}" 
                                               Foreground="{StaticResource TextMuted}" Width="30"/>
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"/>
                                </DockPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </DataTemplate>

            <!-- NEW: Generic Type Argument Template -->
            <DataTemplate x:Key="GenericTypeParamTemplate" DataType="{x:Type vm:GenericTypeArgumentViewModel}">
                <StackPanel Margin="0,5" Orientation="Horizontal">
                    <TextBlock Text="{Binding GenericParameterName, StringFormat='Type {0}: '}" 
                               FontWeight="Bold" Foreground="#C586C0" VerticalAlignment="Center"/>
                    <ComboBox ItemsSource="{Binding AvailableTypes}" 
                              SelectedItem="{Binding SelectedType}"
                              Width="150" Margin="5,0">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>
            </DataTemplate>

            <!-- Selector -->
            <selectors:ParameterTemplateSelector x:Key="ParameterSelector"
                StringTemplate="{StaticResource StringParamTemplate}"
                IntTemplate="{StaticResource IntParamTemplate}"
                BoolTemplate="{StaticResource BoolParamTemplate}"
                EnumTemplate="{StaticResource EnumParamTemplate}"
                JsonTemplate="{StaticResource JsonParamTemplate}"
                CollectionTemplate="{StaticResource CollectionParamTemplate}"
                GenericTypeTemplate="{StaticResource GenericTypeParamTemplate}"/>
        </ResourceDictionary>
    </Application.Resources>
</Application>
