<Window x:Class="DotNetDllInvoker.UI.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:DotNetDllInvoker.UI.ViewModels"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" Height="768" Width="1280"
        WindowStartupLocation="CenterScreen">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <!-- Main Container -->
    <Grid Background="{StaticResource WindowBackground}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Status/Toolbar merged? No, Toolbar top -->
            <RowDefinition Height="*"/>   <!-- Content -->
            <RowDefinition Height="Auto"/> <!-- Status -->
        </Grid.RowDefinitions>
        
        <!-- Toolbar (Header) -->
        <Border Grid.Row="0" Background="{StaticResource SurfaceBackground}" Padding="10" BorderThickness="0,0,0,1" BorderBrush="{StaticResource BorderBrush}">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                     <TextBlock Text="DotNet DLL Invoker" FontWeight="Bold" FontSize="16" Foreground="{StaticResource AccentBrush}" VerticalAlignment="Center" Margin="0,0,20,0"/>
                     <Button Command="{Binding LoadDllCommand}" Content="ðŸ“‚ Load DLL" Style="{StaticResource ModernButtonStyle}"/>
                     
                     <Button Command="{Binding InvokeAllCommand}" Content="âš  Invoke All" Style="{StaticResource DangerButtonStyle}" Margin="10,0"/>
                </StackPanel>
                
                <!-- Right Side Info -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding IsStealthModeEnabled}" 
                              Content="ðŸ•µï¸ Stealth Mode" 
                              Foreground="{StaticResource TextSecondary}" 
                              VerticalAlignment="Center" 
                              Margin="0,0,15,0">
                        <CheckBox.ToolTip>
                            <ToolTip>
                                <TextBlock>
                                    <Run FontWeight="Bold" Text="Stealth Mode (V14)" />
                                    <LineBreak />
                                    <Run Text="Routes execution to a separate pre-warmed worker process." />
                                    <LineBreak />
                                    <Run Text="â€¢ Prevents UI crashes (e.g., Environment.Exit)" />
                                    <LineBreak />
                                    <Run Text="â€¢ Isolates potentially malicious side effects" />
                                </TextBlock>
                            </ToolTip>
                        </CheckBox.ToolTip>
                    </CheckBox>
                    <TextBlock Text="v14.0" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center"/>
                </StackPanel>
            </DockPanel>
        </Border>
        
        <!-- Main Content -->
        <Grid Grid.Row="1">
             <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="150"/> <!-- 1. Assembly Explorer -->
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="320" MinWidth="200"/> <!-- 2. Method Browser -->
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*" MinWidth="300"/>   <!-- 3. Cockpit -->
            </Grid.ColumnDefinitions>
            
            <!-- Panel 1: DLL Manager -->
            <Grid Grid.Column="0" Background="{StaticResource PanelBackground}" AllowDrop="True" Drop="OnDllDrop" DragOver="OnDllDragOver">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <Border BorderThickness="0,0,0,1" BorderBrush="{StaticResource BorderBrush}" Padding="10">
                    <TextBlock Text="ASSEMBLIES" FontWeight="Bold" Foreground="{StaticResource TextSecondary}"/>
                </Border>
                
                <ListView Grid.Row="1" ItemsSource="{Binding LoadedAssemblies}" SelectedItem="{Binding SelectedAssembly}" BorderThickness="0" Background="Transparent" Margin="0,5">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem" BasedOn="{StaticResource {x:Type ListViewItem}}">
                            <!-- Helper for ContextMenu binding -->
                            <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            <Setter Property="ContextMenu">
                                <Setter.Value>
                                    <ContextMenu>
                                         <MenuItem Header="ðŸ“Š Call Graph" 
                                                  Command="{Binding PlacementTarget.Tag.ShowCallGraphCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                  CommandParameter="{Binding}"/>
                                         <Separator/>
                                         <MenuItem Header="ðŸ”— Dependencies" 
                                                  Command="{Binding PlacementTarget.Tag.ShowDependenciesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                  CommandParameter="{Binding}"/>
                                         <Separator/>
                                         <MenuItem Header="ðŸ—‘ Unload DLL" 
                                                  Command="{Binding PlacementTarget.Tag.UnloadDllCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                  CommandParameter="{Binding}"/>
                                    </ContextMenu>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="2">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="{Binding FilePath}" Foreground="{StaticResource TextMuted}" FontSize="10" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
            
            <!-- Splitter 1 -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" Background="{StaticResource BorderBrush}" Cursor="SizeWE"/>
            
            <!-- Panel 2: Method List -->
            <Grid Grid.Column="2" Background="{StaticResource SurfaceBackground}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>  <!-- Search Row -->
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <Border BorderThickness="0,0,0,1" BorderBrush="{StaticResource BorderBrush}" Padding="10">
                     <TextBlock Text="METHODS" FontWeight="Bold" Foreground="{StaticResource TextSecondary}"/>
                </Border>
                
                <!-- Search Box -->
                <Border Grid.Row="1" Padding="10,5">
                    <TextBox Text="{Binding MethodSearchText, UpdateSourceTrigger=PropertyChanged}" 
                             Padding="5" Background="#2D2D30" Foreground="White" BorderThickness="1" BorderBrush="{StaticResource BorderBrush}"
                             Tag="ðŸ” Search methods..."/>
                </Border>

                <ListView Grid.Row="2" ItemsSource="{Binding FilteredMethods}" SelectedItem="{Binding SelectedMethod}" BorderThickness="0" Background="Transparent" Margin="0,5">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="2">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" FontSize="13"/>
                                <TextBlock Text="{Binding Signature}" Foreground="{StaticResource TextMuted}" FontSize="11" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </Grid>
            
            <!-- Splitter 2 -->
            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Stretch" Background="{StaticResource BorderBrush}" Cursor="SizeWE"/>
            
            <!-- Panel 3: Cockpit (Execution) -->
            <Grid Grid.Column="4" Background="{StaticResource WindowBackground}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" /> <!-- Header -->
                    <RowDefinition Height="*" MinHeight="100"/>   <!-- Inputs -->
                    <RowDefinition Height="5"/>     <!-- Splitter -->
                    <RowDefinition Height="200" MinHeight="100"/>    <!-- Output/Code -->
                </Grid.RowDefinitions>

                <!-- 0: Header -->
                <Border Grid.Row="0" Padding="20" BorderThickness="0,0,0,1" BorderBrush="{StaticResource BorderBrush}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{Binding SelectedMethod.Name, TargetNullValue='Select a Method'}" FontSize="24" FontWeight="Bold" Foreground="{StaticResource AccentBrush}"/>
                            <TextBlock Text="{Binding SelectedMethod.Signature}" FontSize="14" FontFamily="Consolas" Foreground="{StaticResource TextSecondary}" TextWrapping="Wrap" Margin="0,5,0,0"/>
                            <TextBlock Text="{Binding SelectedAssembly.Name, StringFormat='Assembly: {0}'}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,5,0,0"/>
                        </StackPanel>
                        
                        <Button Grid.Column="1" Content="â–¶" 
                                Command="{Binding SelectedMethod.InvokeCommand}" 
                                Visibility="{Binding IsMethodSelected, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}"
                                Style="{StaticResource DangerButtonStyle}"
                                Width="50" Height="50" VerticalAlignment="Top" Margin="20,0,0,0"
                                ToolTip="Invoke Method"/>
                    </Grid>
                </Border>

                <!-- 1: Dynamic Inputs -->
                <Grid Grid.Row="1" Margin="20">
                     <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="PARAMETERS" FontWeight="Bold" Foreground="{StaticResource TextSecondary}" Margin="0,0,0,10"/>
                    
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding SelectedMethod.Parameters}" ItemTemplateSelector="{StaticResource ParameterSelector}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
                
                <!-- Vertical Splitter -->
                <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" Background="{StaticResource BorderBrush}" Cursor="SizeNS"/>

                <!-- 3: Output / Definition Tabs -->
                <Grid Grid.Row="3">
                     <TabControl Background="Transparent" BorderThickness="0" Margin="10,0,10,10">
                        <TabItem Header="DEBUG OUTPUT">
                            <Border Background="{StaticResource SurfaceBackground}" CornerRadius="3" Padding="10">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBox Grid.Row="0" Text="{Binding LastResult.OutputText, Mode=OneWay}" IsReadOnly="True" FontFamily="Consolas" VerticalScrollBarVisibility="Auto" Background="#111111" Foreground="#CCCCCC" BorderThickness="0"/>
                                    
                                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,5,0,0">
                                        <TextBlock Text="Return: " FontWeight="Bold" Foreground="{StaticResource TextSecondary}"/>
                                        <TextBlock Text="{Binding LastResult.ResultValue}" FontFamily="Consolas" Foreground="#FFD700"/>
                                        <TextBlock Text="{Binding LastResult.Duration, StringFormat=' (Time: {0})'}" Margin="10,0,0,0" Foreground="{StaticResource TextMuted}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </TabItem>
                        
                        <TabItem Header="IL INSTRUCTIONS">
                            <Border Background="{StaticResource SurfaceBackground}" CornerRadius="3" Padding="0">
                                <TextBox Text="{Binding SelectedMethod.ILCode, Mode=OneWay}" IsReadOnly="True" FontFamily="Consolas" VerticalScrollBarVisibility="Auto" Background="#111111" Foreground="#CE9178" BorderThickness="0" Padding="10"/>
                            </Border>
                        </TabItem>
                        
                        <TabItem Header="C# DEFINITION">
                             <Border Background="{StaticResource SurfaceBackground}" CornerRadius="3" Padding="0">
                                 <TextBox Text="{Binding SelectedMethod.CSCode, Mode=OneWay}" IsReadOnly="True" FontFamily="Consolas" VerticalScrollBarVisibility="Auto" Background="#111111" Foreground="#569CD6" BorderThickness="0" Padding="10"/>
                             </Border>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Grid>
            
            <!-- Dependency Sidebar (Right Overlay) -->
            <Grid Grid.Column="2" Width="300" HorizontalAlignment="Right" Background="{StaticResource SurfaceBackground}" 
                  Visibility="{Binding IsDependencyPanelVisible, Converter={StaticResource BoolToVis}}">
                 <Grid.Effect>
                    <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.5"/>
                </Grid.Effect>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="15">
                    <DockPanel>
                        <Button DockPanel.Dock="Right" Content="âœ•" Command="{Binding CloseDependencyPanelCommand}" Style="{StaticResource ModernButtonStyle}" Background="Transparent" Padding="5"/>
                        <TextBlock Text="Dependencies" FontWeight="Bold" Foreground="{StaticResource TextPrimary}" VerticalAlignment="Center" FontSize="14"/>
                    </DockPanel>
                </Border>
                <ListView Grid.Row="1" ItemsSource="{Binding Dependencies}" Background="Transparent" BorderThickness="0" Foreground="White" Margin="10">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="5">
                                <TextBlock Text="{Binding AssemblyName.Name}" FontWeight="Bold"/>
                                <TextBlock Text="{Binding Status}" FontSize="11">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="Resolved">
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="Unresolved">
                                                    <Setter Property="Foreground" Value="#FF7777"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="LoadError">
                                                    <Setter Property="Foreground" Value="{StaticResource DangerBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Text="{Binding ResolvedPath}" FontSize="9" Foreground="{StaticResource TextMuted}" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                
                <!-- Empty State Message -->
                <TextBlock Grid.Row="1" Text="No External Dependencies" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center" FontStyle="Italic">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Dependencies.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Background="{StaticResource SurfaceBackground}" Foreground="{StaticResource TextPrimary}" Padding="5">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" FontSize="12"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <ProgressBar Width="120" Height="4" IsIndeterminate="True" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" Background="Transparent" BorderThickness="0" Foreground="{StaticResource AccentBrush}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
